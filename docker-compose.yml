version: "3.8"

services:
  smart-home-state:
    image: ghcr.io/sgabalda/smart-home-state:latest
    container_name: smart-home-state
    restart: unless-stopped

    # Environment variables - customize these for your setup
    environment:
      - JAVA_OPTS=-Xmx256m -Xms128m -XX:+UseG1GC -XX:+UseContainerSupport
      # Application configuration via environment variables (no defaults - see application.conf)
      - MQTT_BROKER_HOST=${MQTT_BROKER_HOST}
      - MQTT_BROKER_PORT=${MQTT_BROKER_PORT}
      - MQTT_CLIENT_ID=${MQTT_CLIENT_ID}
      - MQTT_TRACE_MESSAGES=${MQTT_TRACE_MESSAGES}
      - OPENHAB_HOST=${OPENHAB_HOST}
      - OPENHAB_PORT=${OPENHAB_PORT}
      - OPENHAB_API_TOKEN=${OPENHAB_API_TOKEN}
      - STATE_PERSISTENCE_PATH=${STATE_PERSISTENCE_PATH}
      - STATE_PERSISTENCE_INTERVAL=${STATE_PERSISTENCE_INTERVAL}

    # Volumes for persistent data
    volumes:
      - ./data:/app/data # Application data (state.json only)
      - ./logs:/app/logs # Application logs
      - /etc/localtime:/etc/localtime:ro # Sync timezone with host

    # Network configuration
    network_mode: host # Use host networking for easier MQTT/OpenHAB access

    # Health check
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep '[j]ava' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resource limits for Raspberry Pi 3B+
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

    # Labels for Watchtower
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Watchtower for automatic updates
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped

    environment:
      - WATCHTOWER_CLEANUP=true # Remove old images
      - WATCHTOWER_POLL_INTERVAL=300 # Check every 5 minutes
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_ROLLING_RESTART=true # Zero-downtime updates
      - WATCHTOWER_LABEL_ENABLE=true # Only watch labeled containers
      - WATCHTOWER_NOTIFICATIONS=email # Email notifications
      - WATCHTOWER_NOTIFICATION_EMAIL_FROM=${NOTIFICATION_EMAIL_FROM}
      - WATCHTOWER_NOTIFICATION_EMAIL_TO=${NOTIFICATION_EMAIL_TO}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER=${NOTIFICATION_EMAIL_SERVER:-smtp.gmail.com}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT=${NOTIFICATION_EMAIL_SERVER_PORT:-587}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_USER=${NOTIFICATION_EMAIL_USER}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PASSWORD=${NOTIFICATION_EMAIL_PASSWORD}
      - WATCHTOWER_NOTIFICATION_EMAIL_DELAY=2
      - WATCHTOWER_NOTIFICATION_EMAIL_SUBJECTTAG=${NOTIFICATION_EMAIL_SUBJECT_TAG:-[Smart Home]}

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

    # Only monitor containers with the watchtower.enable label
    command: --label-enable --cleanup --interval 300

networks:
  default:
    name: smart-home-network
