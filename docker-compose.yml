services:
  smart-home-state:
    image: ghcr.io/sgabalda/smart-home-state:stable
    container_name: smart-home-state
    restart: unless-stopped

    environment:
      - JAVA_OPTS=-Xmx256m -Xms256m -XX:+UseG1GC -XX:+UseContainerSupport

    env_file:
      - .env

    # Volumes for persistent data
    volumes:
      - ./data:/app/data # Application data (state.json only)
      - ./logs:/app/logs # Application logs
      - /etc/localtime:/etc/localtime:ro # Sync timezone with host

    # Network configuration
    network_mode: host # Use host networking for easier MQTT/OpenHAB access

    # Health check
    # docker and watchtower do not restart the container on health check failure,
    # but it can be used to monitor the container status. If needed, an external script
    # can be created to restart the container based on its health status, such as a cron job.
    # * * * * * docker ps -q -f health=unhealthy | xargs --no-run-if-empty docker restart
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Resource limits for Raspberry Pi 3B+
    deploy:
      resources:
        limits:
          memory: 384M
        reservations:
          memory: 384M

    # Labels for Watchtower
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Watchtower for automatic updates
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped

    environment:
      - WATCHTOWER_CLEANUP=true # Remove old images
      - WATCHTOWER_POLL_INTERVAL=300 # Check every 5 minutes
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_ROLLING_RESTART=true # Zero-downtime updates
      - WATCHTOWER_LABEL_ENABLE=true # Only watch labeled containers
      - WATCHTOWER_NOTIFICATIONS=email # Email notifications
      - WATCHTOWER_NOTIFICATION_EMAIL_FROM=${NOTIFICATION_EMAIL_FROM}
      - WATCHTOWER_NOTIFICATION_EMAIL_TO=${NOTIFICATION_EMAIL_TO}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER=${NOTIFICATION_EMAIL_SERVER:-smtp.gmail.com}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PORT=${NOTIFICATION_EMAIL_SERVER_PORT:-587}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_USER=${NOTIFICATION_EMAIL_USER}
      - WATCHTOWER_NOTIFICATION_EMAIL_SERVER_PASSWORD=${NOTIFICATION_EMAIL_PASSWORD}
      - WATCHTOWER_NOTIFICATION_EMAIL_DELAY=2
      - WATCHTOWER_NOTIFICATION_EMAIL_SUBJECTTAG=${NOTIFICATION_EMAIL_SUBJECT_TAG:-[Smart Home]}

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

    # Only monitor containers with the watchtower.enable label

networks:
  default:
    name: smart-home-network
